name: üöÄ Deploy to Production

# –ö–æ–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç–∏:
on:
  push:
    branches: [main]  # –ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –ø—Ä–∏ push –¥–æ main
  workflow_dispatch:  # –ú–æ–∂–Ω–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Ä—É—á–Ω—É –∑ GitHub UI

jobs:
  deploy:
    name: üèóÔ∏è Build and Deploy
    runs-on: ubuntu-latest  # GitHub —Å—Ç–≤–æ—Ä—é—î Ubuntu –º–∞—à–∏–Ω—É

    steps:
      # –ö—Ä–æ–∫ 1: –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ–¥ –∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
      - name: üì• Checkout code
        uses: actions/checkout@v3

      # –ö—Ä–æ–∫ 2: –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ Node.js 20
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      # –ö—Ä–æ–∫ 3: –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
      - name: üì¶ Install dependencies
        run: npm ci  # ci —à–≤–∏–¥—à–µ –Ω—ñ–∂ install

      # –ö—Ä–æ–∫ 4: –û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (—è–∫—â–æ —â–µ –Ω–µ –∑—Ä–æ–±–ª–µ–Ω–æ)
      - name: üñºÔ∏è Optimize images
        run: npm run optimize:images
        continue-on-error: true  # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ —è–∫—â–æ –≤–∂–µ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω—ñ

      # –ö—Ä–æ–∫ 5: –ó—ñ–±—Ä–∞—Ç–∏ –ø—Ä–æ—î–∫—Ç
      - name: üèóÔ∏è Build project
        run: npm run build
        env:
          VITE_SITE_URL: https://diwave.company

      # –ö—Ä–æ–∫ 6: –ê—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏ build –¥–ª—è —à–≤–∏–¥—à–æ—ó –ø–µ—Ä–µ–¥–∞—á—ñ
      - name: üì¶ Create archive
        run: tar -czf dist.tar.gz dist/

      # –ö—Ä–æ–∫ 7: –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∞—Ä—Ö—ñ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: üöÄ Deploy to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "dist.tar.gz"
          target: "/tmp/"

      # –ö—Ä–æ–∫ 8: –†–æ–∑–∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏ —ñ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
      - name: üîÑ Extract and Restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "üîÑ Deploying Diwave..."

            # Backup —Å—Ç–∞—Ä–æ—ó –≤–µ—Ä—Å—ñ—ó
            if [ -d /var/www/diwave/dist.backup ]; then
              rm -rf /var/www/diwave/dist.backup
            fi
            if [ -d /var/www/diwave/dist ]; then
              mv /var/www/diwave/dist /var/www/diwave/dist.backup
            fi

            # –†–æ–∑–∞—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏ –Ω–æ–≤—É –≤–µ—Ä—Å—ñ—é
            cd /var/www/diwave
            tar -xzf /tmp/dist.tar.gz
            rm /tmp/dist.tar.gz

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ Nginx
            sudo systemctl reload nginx

            echo "‚úÖ Deployment completed!"
            echo "üåê Site: https://diwave.company"

      # –ö—Ä–æ–∫ 9: –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—Ö
      - name: ‚úÖ Deployment Success
        if: success()
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "üåê Site: https://diwave.company"
          echo "‚è∞ Time: $(date)"

      # –ö—Ä–æ–∫ 10: –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
      - name: ‚ùå Deployment Failed
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check logs above for details"
